services:

  mlflow:
    build:
      context: .
      dockerfile: Dockerfile.mlflow
      args:
        MLFLOW_VERSION: ${MLFLOW_VERSION}
    container_name: mlflow-server
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
    ports:
      - "5050:5000"
    volumes:
      - ./mlflow_db:/mlflow/db
    command: >
      mlflow server --backend-store-uri sqlite:////mlflow/db/mlflow.db --artifacts-destination s3://${MLFLOW_ARTIFACTS_BUCKET}/mlflow-artifacts --host 0.0.0.0 --port 5000

  trainer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: titanic-trainer
    depends_on:
      - mlflow
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
      - GIT_PYTHON_REFRESH=quiet
      - GIT_PYTHON_GIT_EXECUTABLE=/usr/bin/git
      - DATASET_LOCAL_PATH=/app/titanic.csv
      - PYTHONUNBUFFERED=1
    volumes:
      - .:/app
    command: python main.py
